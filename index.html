<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>TTE Público Chile 2025 + KMZ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; font-family: Arial, sans-serif; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    .loading { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.7); color:white; padding:10px; border-radius:8px; z-index:1000; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>
<div id="map"></div>
<div class="loading" id="loading">Cargando rutas KMZ...</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/tokml@0.4.0/tokml.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.1/dist/togeojson.umd.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
  const map = L.map('map').setView([-33.45, -70.65], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  // <-- AQUÍ PEGAS EL LINK RAW DE TU KMZ SUBIDO A GITHUB -->
  const kmzUrl = "https://raw.githubusercontent.com/njerez-ctrl/TTEpublico/main/Rutas-al-08Nov2025.kmz";   // ← cambia "rutas.kmz" por el nombre real

  fetch(kmzUrl)
    .then(r => r.arrayBuffer())
    .then(buffer => JSZip.loadAsync(buffer))
    .then(zip => zip.file("doc.kml")[0].async("string"))
    .then(kmlText => {
      const kmlText = kmlText.replace(/<gx:Track>/g, '<Track>').replace(/<\/gx:Track>/g, '</Track>');
      const kmlDoc = new DOMParser().parseFromString(kmlText, "text/xml");
      const geojson = toGeoJSON.kml(kmlDoc);

      L.geoJSON(geojson, {
        style: feature => ({
          color: feature.properties?.stroke || "#e74c3c",
          weight: feature.properties?.strokeWidth || 4,
          opacity: 0.9
        }),
        onEachFeature: (feature, layer) => {
          if (feature.properties?.name) {
            layer.bindPopup(`<b>${feature.properties.name}</b>`);
          }
        }
      }).addTo(map);

      map.fitBounds(L.geoJSON(geojson).getBounds());
      document.getElementById("loading").textContent = "¡Rutas cargadas!";
      setTimeout(() => document.getElementById("loading").style.display = "none", 2000);
    })
    .catch(e => {
      console.error(e);
      document.getElementById("loading").textContent = "Error cargando KMZ";
    });
</script>
</body>
</html>
