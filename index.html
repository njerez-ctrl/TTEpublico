<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>TTE Público Chile 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { margin:0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
    #panel { width: 320px; background: #2c3e50; color: white; padding: 20px; overflow-y: auto; }
    #map { flex: 1; }
    h1 { font-size: 24px; margin-bottom: 20px; color: #e74c3c; }
    label { display: block; margin: 14px 0; font-size: 16px; }
    input[type="checkbox"] { transform: scale(1.5); margin-right: 12px; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>

<div id="panel">
  <h1>TTE Público Chile</h1>
  <p><strong>Prende/apaga ciudades:</strong></p>
  <label><input type="checkbox" checked data-city="santiago"> Santiago RED</label>
  <label><input type="checkbox" checked data-city="valpo"> Valparaíso - Viña</label>
  <label><input type="checkbox" checked data-city="conce"> Gran Concepción</label>
  <label><input type="checkbox" checked data-city="antofa"> Antofagasta</label>
  <label><input type="checkbox" checked data-city="temuco"> Temuco</label>
  <label><input type="checkbox" checked data-city="iquique"> Iquique</label>
  <label><input type="checkbox" checked data-city="rancagua"> Rancagua</label>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<script>
  const map = L.map('map').setView([-35.5, -71.5], 5.5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const colores = {
    santiago: "#e74c3c", valpo: "#3498db", conce: "#f1c40f",
    antofa: "#9b59b6", temuco: "#e67e22", iquique: "#1abc9c", rancagua: "#27ae60"
  };

  const capas = {};

  const gtfs = {
    santiago: "https://www.dtpm.cl/descargas/gtfs/gtfs_red.zip",
    valpo:    "https://transparencia.mtt.gob.cl/archivos/GTFS_Valparaiso_2025.zip",
    conce:    "https://transparencia.mtt.gob.cl/archivos/GTFS_Biobio_2025.zip",
    antofa:   "https://transparencia.mtt.gob.cl/archivos/GTFS_Antofagasta_2025.zip",
    temuco:   "https://transparencia.mtt.gob.cl/archivos/GTFS_Temuco_2025.zip",
    iquique:  "https://transparencia.mtt.gob.cl/archivos/GTFS_Iquique_2025.zip",
    rancagua: "https://transparencia.mtt.gob.cl/archivos/GTFS_Rancagua_2025.zip"
  };

  document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    cb.addEventListener('change', function() {
      const city = this.dataset.city;
      if (this.checked) cargarCiudad(city);
      else if (capas[city]) {
        capas[city].forEach(l => map.removeLayer(l));
        delete capas[city];
      }
    });
    if (cb.checked) cargarCiudad(cb.dataset.city);
  });

  async function cargarCiudad(city) {
    if (capas[city]) return;
    capas[city] = [];
    try {
      const r = await fetch(gtfs[city]);
      const zip = await JSZip.loadAsync(await r.arrayBuffer());
      const file = zip.file(/shapes\.txt/i)[0];
      const txt = await file.async("text");

      const shapes = {};
      txt.trim().split('\n').slice(1).forEach(l => {
        const [id, lat, lon] = l.split(',');
        if (!shapes[id]) shapes[id] = [];
        shapes[id].push([parseFloat(lat), parseFloat(lon)]);
      });

      Object.values(shapes).forEach(points => {
        const pl = L.polyline(points, { color: colores[city], weight: 2.8, opacity: 0.8 });
        pl.addTo(map);
        capas[city].push(pl);
      });
    } catch (e) {
      console.error("Error cargando " + city, e);
    }
  }
</script>
</body>
</html>
